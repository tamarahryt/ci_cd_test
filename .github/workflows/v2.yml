name: Check DIM

on:
  workflow_dispatch:
  pull_request:
    paths: ['/views/*.view.lkml']

jobs:
  dimension-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Check Views Have Dimensions
      run: |
        echo "Checking views for dim..."

        #find all view files
        view_files=$(find . -name "*.view.lkml")

        if [ -z "$view_files" ]; then
          echo "ðŸ”» No view files found!"
          echo "::error::No view files found"
          exit 1
        fi
        
        failed_views=""

        #Check each view file
        for file in $view_files; do
          echo "Checking: $file"
          
          #Count DIM in the file
          dimension_count=$(grep -c "^\s*dimension" "$file" || true)

          if [ "dimension_count" -eq 0 ]; then
            echo "ðŸš« FAILED $file has NO dim"
            failed_views="$failed_views $file"
            exit 1
          else
            echo " $file has $dimension_count dim(s)"
          fi
        done

        #report result
        if [ -n "$failed_views" ]; then
          echo ""
          echo "ðŸš« FAILED: These view have no dim:"
          for view in $failed_views; do
            echo " - $view"
          done
          exit 1
        else
          echo ""
          echo "ðŸš€ SUCCESS"
        fi
